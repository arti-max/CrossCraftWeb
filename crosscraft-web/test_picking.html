<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç Color Picking</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #222;
            color: #fff;
        }
        #gameContainer {
            border: 2px solid #444;
            margin: 20px 0;
            width: 800px;
            height: 600px;
        }
        #debugInfo {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            background: #555;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #666;
        }
    </style>
</head>
<body>
    <h1>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç Color Picking</h1>
    
    <div>
        <button onclick="testPicking()">–¢–µ—Å—Ç Picking</button>
        <button onclick="renderFrame()">–ü–æ–∫–∞–∑–∞—Ç—å –∫—É–±</button>
        <button onclick="rotateCube()">–ü–æ–≤–µ—Ä–Ω—É—Ç—å –∫—É–±</button>
        <button onclick="clearDebug()">–û—á–∏—Å—Ç–∏—Ç—å –æ—Ç–ª–∞–¥–∫—É</button>
    </div>
    
    <div id="gameContainer"></div>
    
    <div id="debugInfo"></div>

    <script type="module">
        import { GL11, GL } from './lib/GL11/GL11.js';
        import { BufferUtils } from './lib/GL11/BufferUtils.js';
        import { IntBuffer } from './lib/GL11/IntBuffer.js';
        import { FloatBuffer } from './lib/GL11/FloatBuffer.js';
        import { Tessellator } from './src/render/Tessellator.js';
        
        let canvas = null;
        let debugDiv = null;
        let rotationAngle = 0; // –£–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞ –∫—É–±–∞
        
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º console.log –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addDebugMessage(type, ...args) {
            if (debugDiv) {
                const timestamp = new Date().toLocaleTimeString();
                const message = args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' ');
                
                debugDiv.textContent += `[${timestamp}] ${type}: ${message}\n`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }
        
        console.log = (...args) => {
            originalLog(...args);
            addDebugMessage('LOG', ...args);
        };
        
        console.error = (...args) => {
            originalError(...args);
            addDebugMessage('ERROR', ...args);
        };
        
        console.warn = (...args) => {
            originalWarn(...args);
            addDebugMessage('WARN', ...args);
        };
        
        // –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç picking
        function initSimpleTest() {
            const container = document.getElementById('gameContainer');
            debugDiv = document.getElementById('debugInfo');
            
            canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            container.appendChild(canvas);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º GL11
            GL11.init(canvas);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            GL11.glEnable(GL.TEXTURE_2D);
            GL11.glClearColor(0.2, 0.3, 0.8, 1.0);
            GL11.glEnable(GL.DEPTH_TEST);
            GL11.glDepthFunc(GL.LEQUAL);
            GL11.glViewport(0, 0, canvas.width, canvas.height);
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –Ω–∞—á–∞–ª—å–Ω—ã–π –∫–∞–¥—Ä –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
            renderFrame();
            
            console.log('–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. Canvas:', canvas.width, 'x', canvas.height);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–∞–¥—Ä–∞
        function renderFrame() {
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É —Å –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ü–∏–µ–π
            GL11.glMatrixMode(GL.PROJECTION);
            GL11.glLoadIdentity();
            
            // –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è –¥–ª—è 3D
            const fovy = 45; // –£–≥–æ–ª –æ–±–∑–æ—Ä–∞
            const aspect = canvas.width / canvas.height;
            const near = 0.1;
            const far = 100.0;
            
            // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—É—é –º–∞—Ç—Ä–∏—Ü—É
            const f = Math.tan(Math.PI * 0.5 - 0.5 * fovy * Math.PI / 180);
            const rangeInv = 1.0 / (near - far);
            
            const perspectiveMatrix = new Float32Array([
                f / aspect, 0, 0, 0,
                0, f, 0, 0,
                0, 0, (near + far) * rangeInv, -1,
                0, 0, near * far * rangeInv * 2, 0
            ]);
            
            GL11.glLoadMatrixf(perspectiveMatrix);
            
            GL11.glMatrixMode(GL.MODELVIEW);
            GL11.glLoadIdentity();
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É
            GL11.glTranslatef(0, 0, -5); // –û—Ç–æ–¥–≤–∏–≥–∞–µ–º –∫–∞–º–µ—Ä—É –Ω–∞–∑–∞–¥
            
            // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∫—É–±
            GL11.glRotatef(rotationAngle, 0, 1, 0); // –ü–æ–≤–æ—Ä–æ—Ç –≤–æ–∫—Ä—É–≥ –æ—Å–∏ Y
            
            // –û—á–∏—â–∞–µ–º —ç–∫—Ä–∞–Ω
            GL11.glClear(GL.COLOR_BUFFER_BIT | GL.DEPTH_BUFFER_BIT);
            
            // –†–∏—Å—É–µ–º 3D –∫—É–±
            drawCube();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –∫—É–±–∞
        function drawCube() {
            const t = Tessellator.instance;
            
            // –ü–µ—Ä–µ–¥–Ω—è—è –≥—Ä–∞–Ω—å (–∫—Ä–∞—Å–Ω–∞—è)
            t.begin();
            t.color(1.0, 0.0, 0.0);
            t.vertex(-1, -1, 1);
            t.vertex(1, -1, 1);
            t.vertex(1, 1, 1);
            t.vertex(-1, 1, 1);
            t.end();
            
            // –ó–∞–¥–Ω—è—è –≥—Ä–∞–Ω—å (–∑–µ–ª–µ–Ω–∞—è)
            t.begin();
            t.color(0.0, 1.0, 0.0);
            t.vertex(-1, -1, -1);
            t.vertex(-1, 1, -1);
            t.vertex(1, 1, -1);
            t.vertex(1, -1, -1);
            t.end();
            
            // –í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω—å (—Å–∏–Ω—è—è)
            t.begin();
            t.color(0.0, 0.0, 1.0);
            t.vertex(-1, 1, -1);
            t.vertex(-1, 1, 1);
            t.vertex(1, 1, 1);
            t.vertex(1, 1, -1);
            t.end();
            
            // –ù–∏–∂–Ω—è—è –≥—Ä–∞–Ω—å (–∂–µ–ª—Ç–∞—è)
            t.begin();
            t.color(1.0, 1.0, 0.0);
            t.vertex(-1, -1, -1);
            t.vertex(1, -1, -1);
            t.vertex(1, -1, 1);
            t.vertex(-1, -1, 1);
            t.end();
            
            // –ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω—å (–ø—É—Ä–ø—É—Ä–Ω–∞—è)
            t.begin();
            t.color(1.0, 0.0, 1.0);
            t.vertex(1, -1, -1);
            t.vertex(1, 1, -1);
            t.vertex(1, 1, 1);
            t.vertex(1, -1, 1);
            t.end();
            
            // –õ–µ–≤–∞—è –≥—Ä–∞–Ω—å (–≥–æ–ª—É–±–∞—è)
            t.begin();
            t.color(0.0, 1.0, 1.0);
            t.vertex(-1, -1, -1);
            t.vertex(-1, -1, 1);
            t.vertex(-1, 1, 1);
            t.vertex(-1, 1, -1);
            t.end();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –∫—É–±–∞ —Å picking
        function drawCubeForPicking() {
            const t = Tessellator.instance;
            
            // –ü–µ—Ä–µ–¥–Ω—è—è –≥—Ä–∞–Ω—å (–∫—Ä–∞—Å–Ω–∞—è) - ID 1
            GL11.glPushName(1);
            t.begin();
            t.color(1.0, 0.0, 0.0);
            t.vertex(-1, -1, 1);
            t.vertex(1, -1, 1);
            t.vertex(1, 1, 1);
            t.vertex(-1, 1, 1);
            t.end();
            GL11.glPopName();
            
            // –ó–∞–¥–Ω—è—è –≥—Ä–∞–Ω—å (–∑–µ–ª–µ–Ω–∞—è) - ID 2
            GL11.glPushName(2);
            t.begin();
            t.color(0.0, 1.0, 0.0);
            t.vertex(-1, -1, -1);
            t.vertex(-1, 1, -1);
            t.vertex(1, 1, -1);
            t.vertex(1, -1, -1);
            t.end();
            GL11.glPopName();
            
            // –í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω—å (—Å–∏–Ω—è—è) - ID 3
            GL11.glPushName(3);
            t.begin();
            t.color(0.0, 0.0, 1.0);
            t.vertex(-1, 1, -1);
            t.vertex(-1, 1, 1);
            t.vertex(1, 1, 1);
            t.vertex(1, 1, -1);
            t.end();
            GL11.glPopName();
            
            // –ù–∏–∂–Ω—è—è –≥—Ä–∞–Ω—å (–∂–µ–ª—Ç–∞—è) - ID 4
            GL11.glPushName(4);
            t.begin();
            t.color(1.0, 1.0, 0.0);
            t.vertex(-1, -1, -1);
            t.vertex(1, -1, -1);
            t.vertex(1, -1, 1);
            t.vertex(-1, -1, 1);
            t.end();
            GL11.glPopName();
            
            // –ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω—å (–ø—É—Ä–ø—É—Ä–Ω–∞—è) - ID 5
            GL11.glPushName(5);
            t.begin();
            t.color(1.0, 0.0, 1.0);
            t.vertex(1, -1, -1);
            t.vertex(1, 1, -1);
            t.vertex(1, 1, 1);
            t.vertex(1, -1, 1);
            t.end();
            GL11.glPopName();
            
            // –õ–µ–≤–∞—è –≥—Ä–∞–Ω—å (–≥–æ–ª—É–±–∞—è) - ID 6
            GL11.glPushName(6);
            t.begin();
            t.color(0.0, 1.0, 1.0);
            t.vertex(-1, -1, -1);
            t.vertex(-1, -1, 1);
            t.vertex(-1, 1, 1);
            t.vertex(-1, 1, -1);
            t.end();
            GL11.glPopName();
        }
        
        // –¢–µ—Å—Ç picking
        window.testPicking = function() {
            if (!canvas) {
                console.error('Canvas –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');
                return;
            }
            
            console.log('=== –ù–ê–ß–ê–õ–û –ü–†–û–°–¢–û–ì–û –¢–ï–°–¢–ê PICKING ===');
            
            try {
                // –°–æ–∑–¥–∞–µ–º –±—É—Ñ–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                const selectBuffer = BufferUtils.createIntBuffer(1000);
                
                // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã picking –ü–ï–†–ï–î –Ω–∞—á–∞–ª–æ–º SELECT —Ä–µ–∂–∏–º–∞
                GL11.setupPickCamera(canvas.width / 2, canvas.height / 2);
                console.log(`PICK_DEBUG: Pick coordinates set to center: (${canvas.width / 2}, ${canvas.height / 2})`);
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º picking
                GL11.glSelectBuffer(selectBuffer);
                GL11.glRenderMode(GL.SELECT);
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É –¥–ª—è picking (—Ç–∞–∫–∞—è –∂–µ –∫–∞–∫ –≤ renderFrame)
                GL11.glMatrixMode(GL.PROJECTION);
                GL11.glLoadIdentity();
                
                // –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è –¥–ª—è 3D
                const fovy = 45;
                const aspect = canvas.width / canvas.height;
                const near = 0.1;
                const far = 100.0;
                
                const f = Math.tan(Math.PI * 0.5 - 0.5 * fovy * Math.PI / 180);
                const rangeInv = 1.0 / (near - far);
                
                const perspectiveMatrix = new Float32Array([
                    f / aspect, 0, 0, 0,
                    0, f, 0, 0,
                    0, 0, (near + far) * rangeInv, -1,
                    0, 0, near * far * rangeInv * 2, 0
                ]);
                
                GL11.glLoadMatrixf(perspectiveMatrix);
                
                GL11.glMatrixMode(GL.MODELVIEW);
                GL11.glLoadIdentity();
                
                // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É
                GL11.glTranslatef(0, 0, -5);
                
                // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∫—É–± (—Ç–∞–∫–æ–π –∂–µ —É–≥–æ–ª –∫–∞–∫ –≤ renderFrame)
                GL11.glRotatef(rotationAngle, 0, 1, 0);
                
                // –û—á–∏—â–∞–µ–º —ç–∫—Ä–∞–Ω
                GL11.glClear(GL.COLOR_BUFFER_BIT | GL.DEPTH_BUFFER_BIT);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º name stack
                GL11.glInitNames();
                GL11.glPushName(1); // ID –∫—É–±–∞
                
                // –†–∏—Å—É–µ–º 3D –∫—É–± —Å —Ä–∞–∑–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä–∞–Ω–∏
                drawCubeForPicking();
                
                GL11.glPopName();
                
                // –ó–∞–≤–µ—Ä—à–∞–µ–º picking
                const hits = GL11.glRenderMode(GL.RENDER);
                
                console.log(`Picking –∑–∞–≤–µ—Ä—à–µ–Ω. Hits: ${hits}`);
                
                if (hits > 0) {
                    selectBuffer.flip();
                    const nameCount = selectBuffer.get();
                    const minZ = selectBuffer.get();
                    const maxZ = selectBuffer.get();
                    const names = [];
                    for (let i = 0; i < nameCount; i++) {
                        names.push(selectBuffer.get());
                    }
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∞—è –≥—Ä–∞–Ω—å –±—ã–ª–∞ –≤—ã–±—Ä–∞–Ω–∞
                    const faceNames = ['', '–ü–µ—Ä–µ–¥–Ω—è—è (–∫—Ä–∞—Å–Ω–∞—è)', '–ó–∞–¥–Ω—è—è (–∑–µ–ª–µ–Ω–∞—è)', '–í–µ—Ä—Ö–Ω—è—è (—Å–∏–Ω—è—è)', '–ù–∏–∂–Ω—è—è (–∂–µ–ª—Ç–∞—è)', '–ü—Ä–∞–≤–∞—è (–ø—É—Ä–ø—É—Ä–Ω–∞—è)', '–õ–µ–≤–∞—è (–≥–æ–ª—É–±–∞—è)'];
                    const cubeId = names[0];
                    const faceId = names[1];
                    const faceName = faceNames[faceId] || `–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –≥—Ä–∞–Ω—å (ID: ${faceId})`;
                    
                    console.log(`üéØ –ù–∞–π–¥–µ–Ω –æ–±—ä–µ–∫—Ç:`);
                    console.log(`   –ö—É–± ID: ${cubeId}`);
                    console.log(`   –ì—Ä–∞–Ω—å: ${faceName}`);
                    console.log(`   Names: [${names.join(', ')}]`);
                    console.log(`   Z-–¥–∏–∞–ø–∞–∑–æ–Ω: ${minZ} - ${maxZ}`);
                } else {
                    console.log('‚ùå –û–±—ä–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ picking:', error);
            }
            
            console.log('=== –ö–û–ù–ï–¶ –¢–ï–°–¢–ê PICKING ===');
        };
        
        // –û—á–∏—Å—Ç–∫–∞ –æ—Ç–ª–∞–¥–∫–∏
        window.clearDebug = function() {
            if (debugDiv) {
                debugDiv.textContent = '';
            }
        };
        
        // –î–µ–ª–∞–µ–º renderFrame –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.renderFrame = renderFrame;
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–≤–æ—Ä–æ—Ç–∞ –∫—É–±–∞
        window.rotateCube = function() {
            rotationAngle += 45; // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ 45 –≥—Ä–∞–¥—É—Å–æ–≤
            if (rotationAngle >= 360) {
                rotationAngle = 0;
            }
            console.log(`–ö—É–± –ø–æ–≤–µ—Ä–Ω—É—Ç –Ω–∞ ${rotationAngle} –≥—Ä–∞–¥—É—Å–æ–≤`);
            renderFrame(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫—É–±
        };
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', initSimpleTest);
    </script>
</body>
</html>